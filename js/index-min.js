new Vue({el:"#app",data:{flgName:["fs","fw","fp"],arData:[{title:"床",checks:[{label:"回転",flg:!1,img:"images/rotate.gif"},{label:"球体",flg:!1,img:"images/sphere.png"},{label:"ぽよ",flg:!1,img:"images/poyo.gif"}],imageFile:null,imageUrl:null,size:[2,2],decaFlg:!1,color:"rgb(255, 0, 180)",mesh:null},{title:"奥",checks:[{label:"影　",flg:!1,img:"images/shadow.png"},{label:"曲げ",flg:!1,img:"images/warp_bg.png"},{label:"ぽよ",flg:!1,img:"images/poyo.gif"}],imageFile:null,imageUrl:null,size:[2,2],decaFlg:!1,color:"rgb(0, 0, 255)",mesh:null},{title:"真ん中",checks:[{label:"影　",flg:!1,img:"images/shadow.png"},{label:"曲げ",flg:!1,img:"images/warp.png"},{label:"ぽよ",flg:!1,img:"images/poyo.gif"}],imageFile:null,imageUrl:null,size:[2,2],decaFlg:!1,color:"rgb(0, 220, 255)",mesh:null},{title:"手前",checks:[{label:"影　",flg:!1,img:"images/shadow.png"},{label:"曲げ",flg:!1,img:"images/warp.png"},{label:"ぽよ",flg:!1,img:"images/poyo.gif"}],imageFile:null,imageUrl:null,size:[2,2],decaFlg:!1,color:"rgb(100, 255, 0)",mesh:null},{title:"全天球",checks:[{label:"回転",flg:!1,img:"images/rotate_vr.gif"},{label:"魚眼",flg:!1,img:"images/lens.png"},{label:"青み",flg:!1,img:"images/blue.png"}],imageFile:null,imageUrl:null,size:[9,9],decaFlg:!1,color:"rgb(150, 170, 190)",mesh:null}],arImg:new Array(4),qrCanvas:new Array(4),qrCtx:new Array(4),creatingFlg:!1,resultFlg:!1,pRenderer:null,pScene:null,pCamera:null,pMarkerAr0:null,pMultiGroup:null,tweetUrl:null,optionType:"normal",vrPos:[0,0,-4]},created:function(){var a=this;if(location.search){for(var t={},e=location.search.substring(1).split("&"),r=0;e[r];r++){var i=e[r].split("=");t[i[0]]=decodeURIComponent(i[1])}var n=new Array(a.arData.length).join("0");t.warpList=t.fw&&(n+parseInt(t.fw,16).toString(2)).slice(-1*a.arData.length).split("").reverse(),t.shodowList=t.fs&&(n+parseInt(t.fs,16).toString(2)).slice(-1*a.arData.length).split("").reverse(),t.poyoList=t.fp&&(n+parseInt(t.fp,16).toString(2)).slice(-1*a.arData.length).split("").reverse(),t.decaList=t.fd&&(n+parseInt(t.fd,16).toString(2)).slice(-1*a.arData.length).split("").reverse(),t.sizeList=t.wh&&(n+n+parseInt(t.wh,16).toString(10)).slice(-2*a.arData.length).match(/.{2}/g).reverse(),a.arData.forEach(function(e,r){a.arData[r].imageUrl=t["i"+r],a.arData[r].checks[0].flg=t.shodowList&&!!Number(t.shodowList[r]),a.arData[r].checks[1].flg=t.warpList&&!!Number(t.warpList[r]),a.arData[r].checks[2].flg=t.poyoList&&!!Number(t.poyoList[r]),a.arData[r].decaFlg=t.decaList&&!!Number(t.decaList[r]),a.arData[r].size=[Number(t.sizeList[r][0]),Number(t.sizeList[r][1])]}),a.arData[4].imageUrl?a.optionType="vr":t.multi&&(a.optionType="multi"),t.vrPos&&(a.vrPos=decodeURIComponent(t.vrPos).split(" "))}},mounted:function(){for(var i=this,e=0;e<4;e++)i.arImg[e]=new Image,i.arImg[e].src="images/ar"+e+".png",i.qrCanvas[e]=document.createElement("canvas"),i.qrCtx[e]=i.qrCanvas[e].getContext("2d"),i.qrCanvas[e].width=1024,i.qrCanvas[e].height=1024,i.qrCtx[e].fillStyle="#fff";var r=i.$refs.pCanvas.offsetWidth,a=i.$refs.pCanvas.offsetHeight,t=r/a;i.pRenderer=new THREE.WebGLRenderer({canvas:i.$refs.pCanvas,antialias:!0}),i.pRenderer.setPixelRatio(window.devicePixelRatio),i.pRenderer.setSize(r,a),i.pScene=new THREE.Scene,i.pScene.background=new THREE.Color(16777215),i.pCamera=new THREE.PerspectiveCamera(20,t,1,1e3),i.pCamera.position.set(6,10,10),i.pCamera.lookAt(new THREE.Vector3(0,1,0));var n=new THREE.DirectionalLight(16777215);n.position.set(0,100,100),i.pScene.add(n);var s=new THREE.AmbientLight(16777215,.5);i.pScene.add(s),i.drawMarker(0);var o=new THREE.PlaneGeometry(1.24,1.24),l=new THREE.CanvasTexture(i.qrCanvas[0]),p=new THREE.MeshLambertMaterial({map:l});i.pMarkerAr0=new THREE.Mesh(o,p),i.pMarkerAr0.rotation.set(-Math.PI/2,0,0),i.pMarkerAr0.position.set(0,-.01,0),i.pScene.add(i.pMarkerAr0),i.arData.forEach(function(e,r){var a=new THREE.PlaneGeometry(1,1),t=new THREE.MeshLambertMaterial({color:e.color,transparent:!0,depthTest:!1});e.mesh=new THREE.Mesh(a,t),i.pScene.add(e.mesh)}),i.pUpdate()},watch:{optionType:function(){this.resultFlg=!1,this.pToggleLayout()},viewerUrl:function(){history.replaceState("","",this.queryString),this.pUpdate()}},computed:{isSubmitDisabled:function(){return this.creatingFlg||this.arData.every(function(e){return!e.imageUrl||!e.imageUrl.match(/^http/)})},queryString:function(){var t=this,i="?wh="+t.convert10_16(t.arData.map(function(e){return e.size.join("")}).reverse().join(""));t.flgName.forEach(function(e,r){var a=t.convert2_16(t.arData.map(function(e){return e.checks[r].flg?1:0}).reverse().join(""));"0"!==a&&(i+="&"+e+"="+a)});var e=t.convert2_16(t.arData.map(function(e){return e.decaFlg?1:0}).reverse().join(""));return"0"!==e&&(i+="&fd="+e),t.arData.forEach(function(e,r){!e.imageUrl||4===r&&"vr"!==t.optionType||(i+="&i"+r+"="+e.imageUrl)}),"multi"===t.optionType?i+="&multi=1":"vr"===t.optionType&&(i+="&vrPos="+encodeURIComponent(t.vrPos.join(" "))),i},viewerUrl:function(){return"https://web-ar-viewer.firebaseapp.com"+("vr"===this.optionType?"/vr":"")+this.queryString}},methods:{scroll:function(e){scrollTo(0,window.pageYOffset+e.getBoundingClientRect().top)},selectImage:function(a,e){var t=this;if(e.target.files.length){var r=e.target.files[0],i=new FileReader;i.onload=function(){if(1e7<r.size)return alert("ファイルサイズが10MBを超えています。\nファイルサイズを抑えるか、他のサービスで事前にアップロードしておいたものを使用してください。"),!1;t.arData[a].imageFile=i.result,(new THREE.TextureLoader).load(i.result,function(e){e.minFilter=THREE.LinearFilter;var r=new THREE.MeshLambertMaterial({map:e,transparent:!0,depthTest:!1});t.arData[a].mesh.material=r,t.pUpdate()})},i.readAsDataURL(r)}},uploadImage:function(i){var self=this;self.arData[i].imageUrl="アップロード中…";var req=new XMLHttpRequest;req.open("POST","https://api.imgur.com/3/image",!0),req.setRequestHeader("content-type","application/x-www-form-urlencoded;charset=UTF-8"),req.setRequestHeader("Authorization","Client-ID 14834ce07369dac"),req.onload=function(event){4===req.readyState&&(200===req.status?(self.arData[i].imageUrl=eval("("+req.responseText+")").data.link,self.arData[i].imageFile=null):(self.arData[i].imageUrl=null,alert("アップロードに失敗しました。\nError: "+req.status)))},req.onerror=function(e){self.arData[i].imageUrl=null,alert("アップロード中にエラーが発生しました。")},req.send("image="+encodeURIComponent(self.arData[i].imageFile.split(",")[1]))},cancelImage:function(e){var r=this;r.arData[e].imageFile=null;var a=new THREE.MeshLambertMaterial({color:r.arData[e].color,transparent:!0,depthTest:!1});r.arData[e].mesh.material=a,r.pUpdate()},createAr:function(){var self=this;self.tweetUrl=self.viewerUrl+("vr"===self.optionType?"":"&gyro=1"),self.resultFlg=!1,self.creatingFlg=!0;var req=new XMLHttpRequest;req.open("POST","https://api-ssl.bitly.com/v3/shorten",!0),req.setRequestHeader("content-type","application/x-www-form-urlencoded;charset=UTF-8"),req.onload=function(event){if(4===req.readyState){if(200===req.status)var qrUrl=eval("("+req.responseText+")").data.url;else var qrUrl=self.viewerUrl;var img=new Image;if(img.crossOrigin="Anonymous",img.src="https://chart.apis.google.com/chart?chs="+("vr"===self.optionType?"512x512":"364x364")+"&cht=qr&chl="+encodeURIComponent(qrUrl),img.onload=function(){self.resultFlg=!0,self.creatingFlg=!1,self.drawMarker(0,img)},"multi"===self.optionType){var imgMini=new Image;imgMini.crossOrigin="Anonymous",imgMini.src="https://chart.apis.google.com/chart?chs=244x244&cht=qr&chl="+encodeURIComponent(qrUrl),imgMini.onload=function(){for(var e=1;e<4;e++)self.drawMarker(e,imgMini)}}}},req.onerror=function(e){alert("QRコード生成中にエラーが発生しました。")},req.send("domain=j%2emp&longUrl="+encodeURIComponent(self.viewerUrl)+"&access_token=ea695cba9768d20a417f5162db91ddef4ba81b5c")},convert2_16:function(e){return parseInt(e,2).toString(16)},convert10_16:function(e){return parseInt(e,10).toString(16)},previewViwer:function(){window.open(this.viewerUrl+"&preview=1")},gyroViwer:function(){window.open(this.tweetUrl)},tweet:function(){if("vr"===this.optionType)var e=encodeURIComponent("WebARジェネレータでVRを作ったよ！");else e=encodeURIComponent("WebARジェネレータでARを作ったよ！");window.open("https://twitter.com/intent/tweet?text="+e+"&url="+encodeURIComponent(this.tweetUrl)+"&hashtags=WebARジェネレータ")},drawMarker:function(e,r){var a=this;if(a.qrCtx[e].fillRect(0,0,1024,1024),"vr"===a.optionType&&r)return a.qrCtx[e].drawImage(r,0,0,512,512,0,0,1024,1024),void(a.$refs.vr_img_0.src=a.qrCanvas[e].toDataURL());r&&a.qrCtx[e].drawImage(r,[372,316,390,464][e],[286,316,316,316][e]),a.qrCtx[e].beginPath(),a.qrCtx[e].lineWidth=206,a.qrCtx[e].strokeRect(205,205,614,614),a.qrCtx[e].drawImage(a.arImg[e],332,626),r&&(a.$refs[a.optionType+"_img_"+e].src=a.qrCanvas[e].toDataURL())},pUpdate:function(){var i=this;i.arData.forEach(function(e,r){if(e.mesh.material.opacity=e.imageUrl?.5:.1,0===r)if(e.checks[1].flg){var a=new THREE.SphereGeometry(.5,32,32);e.mesh.geometry=a,e.mesh.rotation.set(0,-Math.PI/2,0),e.mesh.position.set(0,e.size[0]/2,0),e.mesh.scale.set(e.size[0],e.size[0],e.size[0])}else{a=new THREE.PlaneGeometry(1,1);e.mesh.geometry=a,e.mesh.position.set(0,0,0),e.mesh.rotation.set(-Math.PI/2,0,0),e.mesh.scale.set(e.size[0],e.size[1],1)}else if(4===r){a=new THREE.SphereGeometry(20,32,32);e.mesh.geometry=a,e.mesh.material.side=THREE.BackSide,e.mesh.rotation.set(0,-Math.PI/2,0),e.mesh.position.set(0,0,0)}else{if("multi"===i.optionType)var t=[{x:0,z:0},{x:2,z:-2},{x:0,z:-2},{x:-2,z:-2}];else t=[{x:0,z:0},{x:0,z:-i.arData[0].size[1]/2},{x:0,z:0},{x:0,z:i.arData[0].size[1]/2}];e.mesh.position.set(t[r].x,e.size[1]/2,t[r].z),e.mesh.scale.set(e.size[0],e.size[1],1)}}),i.pRenderer.render(i.pScene,i.pCamera)},pToggleLayout:function(){var e=this;if(!e.pMultiGroup){e.pMultiGroup=new THREE.Group;for(var r=1;r<4;r++){e.drawMarker(r);var a=new THREE.PlaneGeometry(1.24,1.24),t=new THREE.CanvasTexture(e.qrCanvas[r]),i=new THREE.MeshLambertMaterial({map:t}),n=new THREE.Mesh(a,i);n.rotation.set(-Math.PI/2,0,0),n.position.set([0,2,0,-2][r],-.01,[0,-2,-2,-2][r]),e.pMultiGroup.add(n)}e.pScene.add(e.pMultiGroup)}"multi"===e.optionType?(e.pCamera.position.set(10,15,15),e.pCamera.lookAt(new THREE.Vector3(1,2,0)),e.pMultiGroup.visible=!0):(e.pCamera.position.set(6,10,10),e.pCamera.lookAt(new THREE.Vector3(0,1,0)),e.pMultiGroup.visible=!1),e.pMarkerAr0.visible="vr"!==e.optionType}}});