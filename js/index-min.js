new Vue({el:"#app",data:{flgName:["fs","fw","fp"],arData:[{title:"床",checks:[{label:"回転",flg:!1,img:"images/rotate.gif"},{label:"球体",flg:!1,img:"images/sphere.png"},{label:"ぽよ",flg:!1,img:"images/poyo.gif"}],imageFile:null,imageUrl:null,size:[2,2],decaFlg:!1,color:"rgb(255, 0, 180)",mesh:null},{title:"奥",checks:[{label:"影",flg:!1,img:"images/shadow.png"},{label:"曲げ",flg:!1,img:"images/warp_bg.png"},{label:"ぽよ",flg:!1,img:"images/poyo.gif"}],imageFile:null,imageUrl:null,size:[2,2],decaFlg:!1,color:"rgb(0, 0, 255)",mesh:null},{title:"真ん中",checks:[{label:"影",flg:!1,img:"images/shadow.png"},{label:"曲げ",flg:!1,img:"images/warp.png"},{label:"ぽよ",flg:!1,img:"images/poyo.gif"}],imageFile:null,imageUrl:null,size:[2,2],decaFlg:!1,color:"rgb(0, 220, 255)",mesh:null},{title:"手前",checks:[{label:"影",flg:!1,img:"images/shadow.png"},{label:"曲げ",flg:!1,img:"images/warp.png"},{label:"ぽよ",flg:!1,img:"images/poyo.gif"}],imageFile:null,imageUrl:null,size:[2,2],decaFlg:!1,color:"rgb(100, 255, 0)",mesh:null}],arImg:null,qrCtx:null,createAreaVisibleFlg:!1,creatingFlg:!1,pRenderer:null,pScene:null,pCamera:null,gyroUrl:null},created:function(){var t=this;if(location.search){for(var r={},e=location.search.substring(1).split("&"),a=0;e[a];a++){var i=e[a].split("=");r[i[0]]=decodeURIComponent(i[1])}var n=new Array(t.arData.length).join("0");r.warpList=r.fw&&(n+parseInt(r.fw,16).toString(2)).slice(-1*t.arData.length).split("").reverse(),r.shodowList=r.fs&&(n+parseInt(r.fs,16).toString(2)).slice(-1*t.arData.length).split("").reverse(),r.poyoList=r.fp&&(n+parseInt(r.fp,16).toString(2)).slice(-1*t.arData.length).split("").reverse(),r.decaList=r.fd&&(n+parseInt(r.fd,16).toString(2)).slice(-1*t.arData.length).split("").reverse(),r.sizeList=r.wh&&(n+n+parseInt(r.wh,16).toString(10)).slice(-2*t.arData.length).match(/.{2}/g).reverse(),t.arData.forEach(function(e,a){t.arData[a].imageUrl=r["i"+a],t.arData[a].checks[0].flg=r.shodowList&&!!Number(r.shodowList[a]),t.arData[a].checks[1].flg=r.warpList&&!!Number(r.warpList[a]),t.arData[a].checks[2].flg=r.poyoList&&!!Number(r.poyoList[a]),t.arData[a].decaFlg=r.decaList&&!!Number(r.decaList[a]),t.arData[a].size=[Number(r.sizeList[a][0]),Number(r.sizeList[a][1])]})}},mounted:function(){var i=this,e=i.$refs.pCanvas.offsetWidth,a=i.$refs.pCanvas.offsetHeight,t=e/a;i.pRenderer=new THREE.WebGLRenderer({canvas:i.$refs.pCanvas,antialias:!0}),i.pRenderer.setPixelRatio(window.devicePixelRatio),i.pRenderer.setSize(e,a),i.pScene=new THREE.Scene,i.pScene.background=new THREE.Color(16777215),i.pCamera=new THREE.PerspectiveCamera(20,t,1,1e3),i.pCamera.position.set(6,10,10),i.pCamera.lookAt(new THREE.Vector3(0,1,0));var r=new THREE.DirectionalLight(16777215);r.position.set(0,100,100),i.pScene.add(r);var n=new THREE.AmbientLight(16777215,.5);i.pScene.add(n);var s=new THREE.PlaneGeometry(1,1),l=new THREE.MeshLambertMaterial({color:0});(o=new THREE.Mesh(s,l)).rotation.set(-Math.PI/2,0,0),o.position.set(0,-.015,0),i.pScene.add(o);var o;s=new THREE.PlaneGeometry(.5,.5),l=new THREE.MeshLambertMaterial({color:16777215});(o=new THREE.Mesh(s,l)).rotation.set(-Math.PI/2,0,0),o.position.set(0,-.01,0),i.pScene.add(o),i.arData.forEach(function(e,a){var t=new THREE.PlaneGeometry(1,1),r=new THREE.MeshLambertMaterial({color:e.color,transparent:!0,depthTest:!1});e.mesh=new THREE.Mesh(t,r),i.pScene.add(e.mesh)}),i.pUpdate()},watch:{viewerUrl:function(){history.replaceState("","",this.queryString),this.pUpdate()}},computed:{isSubmitDisabled:function(){return this.creatingFlg||this.arData.every(function(e){return!e.imageUrl||!e.imageUrl.match(/^http/)})},queryString:function(){var r=this,i="?wh="+r.convert10_16(r.arData.map(function(e){return e.size.join("")}).reverse().join(""));r.flgName.forEach(function(e,a){var t=r.convert2_16(r.arData.map(function(e){return e.checks[a].flg?1:0}).reverse().join(""));"0"!==t&&(i+="&"+e+"="+t)});var e=r.convert2_16(r.arData.map(function(e){return e.decaFlg?1:0}).reverse().join(""));return"0"!==e&&(i+="&fd="+e),r.arData.forEach(function(e,a){e.imageUrl&&(i+="&i"+a+"="+e.imageUrl)}),i},viewerUrl:function(){return"https://web-ar-viewer.firebaseapp.com"+this.queryString}},methods:{scroll:function(e){scrollTo(0,window.pageYOffset+e.getBoundingClientRect().top)},selectImage:function(t,e){var r=this;if(e.target.files.length){var a=e.target.files[0],i=new FileReader;i.onload=function(){if(1e7<a.size)return alert("ファイルサイズが10MBを超えています。\nファイルサイズを抑えるか、他のサービスで事前にアップロードしておいたものを使用してください。"),!1;r.arData[t].imageFile=i.result,(new THREE.TextureLoader).load(i.result,function(e){e.minFilter=THREE.LinearFilter;var a=new THREE.MeshLambertMaterial({map:e,transparent:!0,depthTest:!1});r.arData[t].mesh.material=a,r.pUpdate()})},i.readAsDataURL(a)}},uploadImage:function(i){var self=this;self.arData[i].imageUrl="アップロード中…";var req=new XMLHttpRequest;req.open("POST","https://api.imgur.com/3/image",!0),req.setRequestHeader("content-type","application/x-www-form-urlencoded;charset=UTF-8"),req.setRequestHeader("Authorization","Client-ID 14834ce07369dac"),req.onload=function(event){4===req.readyState&&(200===req.status?(self.arData[i].imageUrl=eval("("+req.responseText+")").data.link,self.arData[i].imageFile=null):(self.arData[i].imageUrl=null,alert("アップロードに失敗しました。\nError: "+req.status)))},req.onerror=function(e){self.arData[i].imageUrl=null,alert("アップロード中にエラーが発生しました。")},req.send("image="+encodeURIComponent(self.arData[i].imageFile.split(",")[1]))},cancelImage:function(e){var a=this;a.arData[e].imageFile=null;var t=new THREE.MeshLambertMaterial({color:a.arData[e].color,transparent:!0,depthTest:!1});a.arData[e].mesh.material=t,a.pUpdate()},createAr:function(){var self=this;self.gyroUrl=self.viewerUrl+"&gyro=1",self.creatingFlg=!0;var req=new XMLHttpRequest;req.open("POST","https://api-ssl.bitly.com/v3/shorten",!0),req.setRequestHeader("content-type","application/x-www-form-urlencoded;charset=UTF-8"),req.onload=function(event){if(4===req.readyState){self.qrCtx||(self.qrCtx=self.$refs.qrCanvas.getContext("2d"),self.qrCtx.fillStyle="#fff"),self.arImg||(self.arImg=new Image,self.arImg.src="images/ar.png"),self.qrCtx.fillRect(0,0,1024,1024);var img=new Image;img.crossOrigin="Anonymous";var chartUrl="https://chart.apis.google.com/chart?chs=364x364&cht=qr&chl=";200===req.status?img.src=chartUrl+encodeURIComponent(eval("("+req.responseText+")").data.url):img.src=chartUrl+encodeURIComponent(self.viewerUrl),img.onload=function(){self.createAreaVisibleFlg=!0,self.qrCtx.drawImage(img,372,286),self.qrCtx.beginPath(),self.qrCtx.lineWidth=206,self.qrCtx.strokeRect(205,205,614,614),self.qrCtx.drawImage(self.arImg,332,626),self.$refs.qrImg.src=self.$refs.qrCanvas.toDataURL(),self.creatingFlg=!1}}},req.onerror=function(e){alert("QRコード生成中にエラーが発生しました。")},req.send("domain=j%2emp&longUrl="+encodeURIComponent(self.viewerUrl)+"&access_token=ea695cba9768d20a417f5162db91ddef4ba81b5c")},convert2_16:function(e){return parseInt(e,2).toString(16)},convert10_16:function(e){return parseInt(e,10).toString(16)},previewViwer:function(){window.open(this.viewerUrl+"&preview=1")},gyroViwer:function(){window.open(this.gyroUrl)},tweetGyro:function(){window.open("https://twitter.com/intent/tweet?text="+encodeURIComponent("WebARジェネレータでARを作ったよ！")+"&url="+encodeURIComponent(this.gyroUrl)+"&hashtags=WebARジェネレータ")},pUpdate:function(){var r=this;r.arData.forEach(function(e,a){if(e.mesh.material.opacity=e.imageUrl?.5:.1,0===a)if(e.checks[1].flg){var t=new THREE.SphereGeometry(.5,32,32);e.mesh.rotation.set(0,-Math.PI/2,0),e.mesh.geometry=t,e.mesh.position.set(0,e.size[1]/2,0),e.mesh.scale.set(e.size[1],e.size[1],e.size[1])}else{t=new THREE.PlaneGeometry(1,1);e.mesh.geometry=t,e.mesh.position.set(0,0,0),e.mesh.rotation.set(-Math.PI/2,0,0),e.mesh.scale.set(e.size[0],e.size[1],1)}else e.mesh.position.set(0,e.size[1]/2,[0,-r.arData[0].size[1]/2,0,r.arData[0].size[1]/2][a]),e.mesh.scale.set(e.size[0],e.size[1],1)}),r.pRenderer.render(r.pScene,r.pCamera)}}});