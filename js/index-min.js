new Vue({el:"#app",data:{flgName:["fw","fs","fp","fk"],touchName:["ft","fg"],arData:[{openFlg:!1,tabOptionType:"effect",title:"床 (または球)",checks:[{label:"球体",flg:!1,img:"images/sphere.png"},{label:"回転",flg:!1,img:"images/rotate.gif"},{label:"ぽよ",flg:!1,img:"images/poyo.gif"},{label:"キラ",flg:!1,img:"images/kira.gif"}],touchChecks:[{label:"くるん",flg:!1,img:"images/turn.gif"},{label:"ぷにっ",flg:!1,img:"images/guni.gif"}],image:{file:null,url:null},map:{file:null,url:null},touch:{file:null,url:null},chromakey:[25,229,51],availableSizeX:[1,2,3,4,5,6,7,8,9,10,20,30,40,50,60,70,80,90],availableSizeY:[0,1,2,3,4,5,6,7,8,9],size:[2,2],decaFlg:!1,color:"rgb(255, 151, 112)",rgba:"rgba(255, 151, 112, 0.3)",mesh:null},{openFlg:!1,tabOptionType:"effect",title:"奥",checks:[{label:"曲げ",flg:!1,img:"images/warp_bg.png"},{label:"影",flg:!1,img:"images/shadow.png"},{label:"ぽよ",flg:!1,img:"images/poyo.gif"},{label:"キラ",flg:!1,img:"images/kira.gif"}],touchChecks:[{label:"くるん",flg:!1,img:"images/turn.gif"},{label:"ぷにっ",flg:!1,img:"images/guni.gif"}],image:{file:null,url:null},map:{file:null,url:null},touch:{file:null,url:null},chromakey:[25,229,51],availableSizeX:[1,2,3,4,5,6,7,8,9,10,20,30,40,50,60,70,80,90],availableSizeY:[1,2,3,4,5,6,7,8,9],size:[2,2],decaFlg:!1,color:"rgb(66, 184, 221)",rgba:"rgba(66, 184, 221, 0.2)",mesh:null},{openFlg:!0,tabOptionType:"effect",title:"真ん中",checks:[{label:"曲げ",flg:!1,img:"images/warp.png"},{label:"影",flg:!1,img:"images/shadow.png"},{label:"ぽよ",flg:!1,img:"images/poyo.gif"},{label:"キラ",flg:!1,img:"images/kira.gif"}],touchChecks:[{label:"くるん",flg:!1,img:"images/turn.gif"},{label:"ぷにっ",flg:!1,img:"images/guni.gif"}],image:{file:null,url:null},map:{file:null,url:null},touch:{file:null,url:null},chromakey:[25,229,51],availableSizeX:[1,2,3,4,5,6,7,8,9,10,20,30,40,50,60,70,80,90],availableSizeY:[1,2,3,4,5,6,7,8,9],size:[2,2],decaFlg:!1,color:"rgb(240, 190, 0)",rgba:"rgba(253, 231, 76, 0.4)",mesh:null},{openFlg:!1,tabOptionType:"effect",title:"手前",checks:[{label:"曲げ",flg:!1,img:"images/warp.png"},{label:"影",flg:!1,img:"images/shadow.png"},{label:"ぽよ",flg:!1,img:"images/poyo.gif"},{label:"キラ",flg:!1,img:"images/kira.gif"}],touchChecks:[{label:"くるん",flg:!1,img:"images/turn.gif"},{label:"ぷにっ",flg:!1,img:"images/guni.gif"}],image:{file:null,url:null},map:{file:null,url:null},touch:{file:null,url:null},chromakey:[25,229,51],availableSizeX:[1,2,3,4,5,6,7,8,9,10,20,30,40,50,60,70,80,90],availableSizeY:[1,2,3,4,5,6,7,8,9],size:[2,2],decaFlg:!1,color:"rgb(255, 112, 166)",rgba:"rgba(255, 112, 166, 0.2)",mesh:null},{openFlg:!0,tabOptionType:"effect",title:"全天球",checks:[{label:"魚眼",flg:!1,img:"images/lens.png"},{label:"回転",flg:!1,img:"images/rotate_vr.gif"},{label:"青み",flg:!1,img:"images/blue.png"},{label:null,flg:!1,img:null}],touchChecks:[{label:null,flg:!1,img:null},{label:null,flg:!1,img:null}],image:{file:null,url:null},map:{file:null,url:null},touch:{file:null,url:null},chromakey:[25,229,51],size:[9,9],decaFlg:!1,color:"rgb(160, 165, 170)",rgba:"rgba(160, 165, 170, 0.2)",mesh:null}],arImg:new Array(4),qrCanvas:new Array(4),qrCtx:new Array(4),creatingFlg:!1,resultFlg:!1,pRenderer:null,pScene:null,pCamera:null,pGeoPlane:new THREE.PlaneGeometry(1,1),pGeoPlaneFine:new THREE.PlaneGeometry(1,1,64,64),pGeoSphere:new THREE.SphereGeometry(.5,32,16),pGeoSphereFine:new THREE.SphereGeometry(.5,128,64),pMarkerAr0:null,pMultiGroup:null,zoomRange:1,tweetUrl:null,optionType:"normal",vrPos:[0,0,-4],offset:[0,0,0],markerAr0TurnFlg:!1,detailOpenFlg:!1,screenWidth:0},created:function(){var r=this;if(r.screenWidth=window.innerWidth,location.search){for(var i={},e=location.search.substring(1).split("&"),a=0;e[a];a++){var t=e[a].split("=");i[t[0]]=decodeURIComponent(t[1])}var l=new Array(r.arData.length).join("0");i.warpList=i.fw&&(l+parseInt(i.fw,16).toString(2)).slice(-1*r.arData.length).split("").reverse(),i.shodowList=i.fs&&(l+parseInt(i.fs,16).toString(2)).slice(-1*r.arData.length).split("").reverse(),i.poyoList=i.fp&&(l+parseInt(i.fp,16).toString(2)).slice(-1*r.arData.length).split("").reverse(),i.kiraList=i.fk&&(l+parseInt(i.fk,16).toString(2)).slice(-1*r.arData.length).split("").reverse(),i.turnList=i.ft&&(l+parseInt(i.ft,16).toString(2)).slice(-1*r.arData.length).split("").reverse(),i.guniList=i.fg&&(l+parseInt(i.fg,16).toString(2)).slice(-1*r.arData.length).split("").reverse(),i.decaList=i.fd&&(l+parseInt(i.fd,16).toString(2)).slice(-1*r.arData.length).split("").reverse(),i.sizeList=i.wh&&(l+l+parseInt(i.wh,16).toString(10)).slice(-2*r.arData.length).match(/.{2}/g).reverse(),r.arData.forEach(function(e,a){if(r.arData[a].image.url=i["i"+a],r.arData[a].map.url=i["m"+a],r.arData[a].touch.url=i["t"+a],r.arData[a].checks[0].flg=i.warpList&&!!Number(i.warpList[a]),r.arData[a].checks[1].flg=i.shodowList&&!!Number(i.shodowList[a]),r.arData[a].checks[2].flg=i.poyoList&&!!Number(i.poyoList[a]),r.arData[a].checks[3].flg=i.kiraList&&!!Number(i.kiraList[a]),r.arData[a].touchChecks[0].flg=i.turnList&&!!Number(i.turnList[a]),r.arData[a].touchChecks[1].flg=i.guniList&&!!Number(i.guniList[a]),r.arData[a].decaFlg=i.decaList&&!!Number(i.decaList[a]),r.arData[a].size=[Number(i.sizeList[a][0]),Number(i.sizeList[a][1])],r.arData[a].decaFlg&&(r.arData[a].size[0]*=10),i["i"+a]&&(r.arData[a].openFlg=!0),i["kc"+a]){var t=decodeURIComponent(i["kc"+a]).split(" ");r.arData[a].chromakey=t.map(function(e){return Math.round(255*e)})}}),r.arData[4].image.url?r.optionType="vr":i.multi&&(r.optionType="multi"),i.vrPos&&(r.vrPos=decodeURIComponent(i.vrPos).split(" ")),i.offset&&(r.offset=decodeURIComponent(i.offset).split(" "))}},mounted:function(){for(var r=this,e=0;e<4;e++)r.arImg[e]=new Image,r.arImg[e].src="images/ar"+e+".png",r.qrCanvas[e]=document.createElement("canvas"),r.qrCtx[e]=r.qrCanvas[e].getContext("2d"),r.qrCanvas[e].width=1024,r.qrCanvas[e].height=1024,r.qrCtx[e].fillStyle="#fff";var a=r.$refs.pCanvas.offsetWidth,t=r.$refs.pCanvas.offsetHeight,i=a/t;r.pRenderer=new THREE.WebGLRenderer({canvas:r.$refs.pCanvas,antialias:!0}),r.pRenderer.setPixelRatio(window.devicePixelRatio),r.pRenderer.setSize(a,t),r.pScene=new THREE.Scene,r.pScene.background=new THREE.Color(16777215),r.pCamera=new THREE.PerspectiveCamera(20,i,1,1e3),r.pCamera.position.set(6,10,10),r.pCamera.lookAt(new THREE.Vector3(0,1,0));var l=new THREE.DirectionalLight(16777215,.6);l.position.set(0,100,100),r.pScene.add(l);var n=new THREE.AmbientLight(16777215,.8);r.pScene.add(n),r.drawMarker(0);var o=new THREE.CanvasTexture(r.qrCanvas[0]),s=new THREE.MeshBasicMaterial({map:o});r.pMarkerAr0=new THREE.Mesh(r.pGeoPlane,s),r.pMarkerAr0.scale.set(1.24,1.24,1),r.pMarkerAr0.rotation.set(-Math.PI/2,0,0),r.pMarkerAr0.position.set(0,-.01,0),r.pScene.add(r.pMarkerAr0),r.arData.forEach(function(e,a){var t=new THREE.MeshPhongMaterial({color:e.color,transparent:!0,depthTest:!1,side:THREE.DoubleSide});t.displacementBias=-.5,4===a?(e.mesh=new THREE.Mesh(r.pGeoSphere,t),e.mesh.material.side=THREE.BackSide,e.mesh.scale.set(500,500,500),e.mesh.rotation.set(0,-Math.PI/2,0)):e.mesh=new THREE.Mesh(r.pGeoPlane,t),r.pScene.add(e.mesh)}),r.pUpdate()},watch:{optionType:function(){this.resultFlg=!1,this.pToggleLayout()},viewerUrl:function(){history.replaceState("","",this.queryString),this.pUpdate()},zoomRange:function(){var e=this;e.pCamera.zoom=e.zoomRange,e.pCamera.updateProjectionMatrix(),e.pRenderer.render(e.pScene,e.pCamera)}},computed:{allOpenFlg:function(){return this.arData.every(function(e){return e.openFlg})},isSubmitDisabled:function(){var e=this;return e.creatingFlg||e.arData.every(function(e){return!e.image.url})||e.arData.some(function(e){return e.image.url&&!e.image.url.match(/^http/)||e.map.url&&!e.map.url.match(/^http/)||e.touch.url&&!e.touch.url.match(/^http/)})},queryString:function(){var r=this,i="?wh="+r.convert10_16(r.arData.map(function(e){return 9<e.size[0]?(e.decaFlg=!0,e.size[0]/10+""+e.size[1]):(e.decaFlg=!1,e.size.join(""))}).reverse().join(""));r.flgName.forEach(function(e,a){var t=r.convert2_16(r.arData.map(function(e){return e.checks[a].flg?1:0}).reverse().join(""));"0"!==t&&(i+="&"+e+"="+t)}),r.touchName.forEach(function(e,a){var t=r.convert2_16(r.arData.map(function(e){return e.touchChecks[a].flg?1:0}).reverse().join(""));"0"!==t&&(i+="&"+e+"="+t)});var e=r.convert2_16(r.arData.map(function(e){return e.decaFlg?1:0}).reverse().join(""));return"0"!==e&&(i+="&fd="+e),r.arData.forEach(function(e,a){!e.image.url||4===a&&"vr"!==r.optionType||(i+="&i"+a+"="+e.image.url,e.map.url&&(i+="&m"+a+"="+e.map.url),e.touch.url&&(i+="&t"+a+"="+e.touch.url,e.touch.url.match(/\.mp4$/i)&&(i+="&kc"+a+"="+encodeURIComponent(Math.floor(e.chromakey[0]/2.55)/100+" "+Math.floor(e.chromakey[1]/2.55)/100+" "+Math.floor(e.chromakey[2]/2.55)/100))))}),"vr"===r.optionType?i+="&vrPos="+encodeURIComponent(r.vrPos.join(" ")):"multi"===r.optionType?i+="&multi=1":r.offset[0]*r.offset[0]+r.offset[1]*r.offset[1]+r.offset[2]*r.offset[2]&&(i+="&offset="+encodeURIComponent(r.offset.join(" "))),i},viewerUrl:function(){return"https://web-ar-viewer.firebaseapp.com/"+("vr"===this.optionType?"vr/":"")+this.queryString}},methods:{scroll:function(e){scrollTo(0,window.pageYOffset+e.getBoundingClientRect().top)},switchAllOpen:function(a){this.arData.forEach(function(e){e.openFlg=a})},selectImage:function(t,e,a){var r=this;if(e.target.files.length){var i=e.target.files[0],l=new FileReader;l.onload=function(){if(1e7<i.size)return alert("ファイルサイズが10MBを超えています。\nファイルサイズを抑えるか、他のサービスで事前にアップロードしておいたものを使用してください。"),!1;r.arData[t][a].file=l.result;var e=new THREE.TextureLoader;"image"===a?e.load(l.result,function(e){e.minFilter=THREE.LinearFilter;var a=(r.arData[t].mesh.material.map=e).image.width/e.image.height;r.arData[t].size=a<1/9?[1,9]:a<1.2/3?[1,Math.round(1/a)]:a<.6?[2,4]:a<.875?[3,4]:a<4/3.5?[2,2]:a<2/1.2?[4,3]:a<2.5?[4,2]:a<9?[Math.round(a),1]:[9,1],r.arData[t].mesh.material.needsUpdate=!0,r.pUpdate()}):"map"===a&&(0===t&&r.arData[t].checks[0].flg?r.arData[t].mesh.geometry=r.pGeoSphereFine:4!==t&&(r.arData[t].mesh.geometry=r.pGeoPlaneFine),e.load(l.result,function(e){e.minFilter=THREE.LinearFilter,r.arData[t].mesh.material.displacementMap=e,r.arData[t].mesh.material.needsUpdate=!0,r.pUpdate()}))},l.readAsDataURL(i)}},uploadImage:function(i,target){var self=this;self.arData[i][target].url="アップロード中…";var req=new XMLHttpRequest;req.open("POST","https://api.imgur.com/3/image",!0),req.setRequestHeader("content-type","application/x-www-form-urlencoded;charset=UTF-8"),req.setRequestHeader("Authorization","Client-ID 14834ce07369dac"),req.onload=function(event){4===req.readyState&&(200===req.status?(self.arData[i][target].url=eval("("+req.responseText+")").data.link,self.arData[i][target].file=null):(self.arData[i][target].url="",alert("アップロードに失敗しました。\nError: "+req.status)))},req.onerror=function(e){self.arData[i][target].url="",alert("アップロード中にエラーが発生しました。")},req.send("image="+encodeURIComponent(self.arData[i][target].file.split(",")[1]))},cancelImage:function(e,a){var t=this;t.arData[e][a].file=null,"image"===a?(t.arData[e].mesh.material.map=null,t.arData[e].mesh.material.needsUpdate=!0):"map"===a&&(t.arData[e].mesh.material.displacementMap=null,t.arData[e].mesh.material.needsUpdate=!0),t.pUpdate()},createAr:function(){var self=this;"vr"===self.optionType&&!self.arData[4].image.url&&window.confirm("VRモードがオンになっていますが、全天球画像が設定されていません。\nVRモードをオフにしてARを作りますか？")&&(self.optionType="normal"),self.tweetUrl=self.viewerUrl+("vr"===self.optionType?"":"&gyro=1"),self.resultFlg=!1,self.creatingFlg=!0;var req=new XMLHttpRequest;req.open("POST","https://api-ssl.bitly.com/v3/shorten",!0),req.setRequestHeader("content-type","application/x-www-form-urlencoded;charset=UTF-8"),req.onload=function(event){if(4===req.readyState){if(200===req.status)var qrUrl=eval("("+req.responseText+")").data.url;else var qrUrl=self.viewerUrl;var img=new Image;if(img.crossOrigin="Anonymous",img.src="https://chart.apis.google.com/chart?chs="+("vr"===self.optionType?"512x512":"364x364")+"&cht=qr&chl="+encodeURIComponent(qrUrl),img.onload=function(){self.resultFlg=!0,self.creatingFlg=!1,self.drawMarker(0,img)},"multi"===self.optionType){var imgMini=new Image;imgMini.crossOrigin="Anonymous",imgMini.src="https://chart.apis.google.com/chart?chs=244x244&cht=qr&chl="+encodeURIComponent(qrUrl),imgMini.onload=function(){for(var e=1;e<4;e++)self.drawMarker(e,imgMini)}}}},req.onerror=function(e){alert("QRコード生成中にエラーが発生しました。")},req.send("domain=j%2emp&longUrl="+encodeURIComponent(self.viewerUrl)+"&access_token=ea695cba9768d20a417f5162db91ddef4ba81b5c")},convert2_16:function(e){return parseInt(e,2).toString(16)},convert10_16:function(e){return parseInt(e,10).toString(16)},previewViwer:function(){window.open(this.viewerUrl+"&preview=1")},gyroViwer:function(){window.open(this.tweetUrl)},tweet:function(){if("vr"===this.optionType)var e=encodeURIComponent("WebARジェネレータでVRを作ったよ！");else e=encodeURIComponent("WebARジェネレータでARを作ったよ！");window.open("https://twitter.com/intent/tweet?text="+e+"&url="+encodeURIComponent(this.tweetUrl)+"&hashtags=WebARジェネレータ")},drawMarker:function(e,a){var t=this;if(t.qrCtx[e].fillRect(0,0,1024,1024),"vr"===t.optionType&&a)return t.qrCtx[e].drawImage(a,0,0,512,512,0,0,1024,1024),void(t.$refs.vr_img_0.src=t.qrCanvas[e].toDataURL());a&&t.qrCtx[e].drawImage(a,[372,316,390,464][e],[286,316,316,316][e]),t.qrCtx[e].beginPath(),t.qrCtx[e].lineWidth=206,t.qrCtx[e].strokeRect(205,205,614,614),t.qrCtx[e].drawImage(t.arImg[e],332,626),a&&(t.$refs[t.optionType+"_img_"+e].src=t.qrCanvas[e].toDataURL())},pUpdate:function(){var l=this;l.arData.forEach(function(e,a){var t=e.decaFlg?10*e.size[1]:e.size[1];if(e.mesh.material.opacity=e.image.url?.5:.1,0===a)e.checks[0].flg?(e.mesh.geometry=e.mesh.material.displacementMap?l.pGeoSphereFine:l.pGeoSphere,e.mesh.rotation.set(0,-Math.PI/2,0),e.mesh.position.set(0,e.size[0]/2,0),e.mesh.scale.set(e.size[0],e.size[0],e.size[0])):(l.arData[0].mesh.geometry=l.arData[0].mesh.material.displacementMap?l.pGeoPlaneFine:l.pGeoPlane,l.arData[0].mesh.position.set(0,0,0),l.arData[0].mesh.rotation.set(-Math.PI/2,0,0),l.arData[0].mesh.scale.set(e.size[0],t,1),e.mesh.scale.set(e.size[0],t,1));else if(4!==a){if("multi"===l.optionType)var r=[{x:0,z:0},{x:2,z:-2},{x:0,z:-2},{x:-2,z:-2}];else{var i=l.arData[0].decaFlg?10*l.arData[0].size[1]:l.arData[0].size[1];r=[{x:0,z:0},{x:0,z:-i/2},{x:0,z:0},{x:0,z:i/2}]}e.mesh.position.set(r[a].x,t/2,r[a].z),e.mesh.scale.set(e.size[0],t,1)}}),l.pRenderer.render(l.pScene,l.pCamera)},pToggleLayout:function(){var e=this;if(!e.pMultiGroup){e.pMultiGroup=new THREE.Group;for(var a=1;a<4;a++){e.drawMarker(a);var t=new THREE.CanvasTexture(e.qrCanvas[a]),r=new THREE.MeshBasicMaterial({map:t}),i=new THREE.Mesh(e.pGeoPlane,r);i.scale.set(1.24,1.24,1),i.rotation.set(-Math.PI/2,0,0),i.position.set([0,2,0,-2][a],-.01,[0,-2,-2,-2][a]),e.pMultiGroup.add(i)}e.pScene.add(e.pMultiGroup)}"multi"===e.optionType?(e.pCamera.position.set(10,15,15),e.pCamera.lookAt(new THREE.Vector3(1,2,0)),e.pMultiGroup.visible=!0):(e.pCamera.position.set(6,10,10),e.pCamera.lookAt(new THREE.Vector3(0,1,0)),e.pMultiGroup.visible=!1),e.pMarkerAr0.visible="vr"!==e.optionType}}});